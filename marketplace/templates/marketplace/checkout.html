{% extends 'marketplace/base.html' %}
{% load static %}

{% block title %}Checkout - Madidi Market{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Checkout</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Order Summary -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in cart_items %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="h-16 w-16 object-cover rounded-md">
                                        {% else %}
                                            <div class="bg-gray-200 border-2 border-dashed rounded-md h-16 w-16 flex items-center justify-center text-gray-500">
                                                No Image
                                            </div>
                                        {% endif %}
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">{{ item.product.name }}</div>
                                            <div class="text-sm text-gray-500">{{ item.product.business.name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R{{ item.product.price }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.quantity }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">R{{ item.get_total_price }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payment Options and Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 mb-8 sticky top-8">
                <h2 class="text-xl font-semibold mb-4">Payment Method</h2>
                
                <form method="post" action="{% url 'marketplace:process_payment' %}">
                    {% csrf_token %}
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Delivery Options</h3>

                        <div class="space-y-3 mb-4">
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="delivery_option" value="pickup" class="h-4 w-4 text-blue-600 focus:ring-blue-500" checked>
                                <span class="ml-3 text-gray-700">Pickup at Seller's Place</span>
                            </label>

                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="delivery_option" value="delivery" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                <span class="ml-3 text-gray-700">Delivery to My Address</span>
                            </label>
                        </div>

                        <div id="address-section" class="hidden">
                            <h4 class="text-md font-medium mb-2">Delivery Address</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="street_address" class="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
                                    <input type="text" name="street_address" id="street_address" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" name="city" id="city" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
                                        <input type="text" name="postal_code" id="postal_code" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>

                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                    <input type="tel" name="phone" id="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Select Payment Method</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="payment_method" value="credit_card" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-3 text-gray-700">Credit Card</span>
                                </label>

                                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="payment_method" value="bank_transfer" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-3 text-gray-700">Bank Transfer</span>
                                </label>

                                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="payment_method" value="cash_on_delivery" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-3 text-gray-700">Cash on Delivery</span>
                                </label>
                            </div>

                            <!-- Payment Instructions Panel -->
                            <div id="payment-instructions" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-800 mb-2">Payment Instructions</h4>
                                <div id="instruction-content" class="text-sm text-gray-600">
                                    <p>Select a payment method to see instructions.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Order Summary</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span>R{{ total_amount|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tax (15%):</span>
                                <span>R{{ tax|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg pt-2 border-t">
                                <span>Total:</span>
                                <span>R{{ total_with_tax|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary w-full px-6 py-3">Place Order</button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-3">Shipping Address</h3>
                <p class="text-gray-600">{{ user.userprofile.address|default:"No address provided" }}</p>
                <a href="#" class="text-blue-600 hover:underline mt-2 inline-block">Change Address</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deliveryOptionRadios = document.querySelectorAll('input[name="delivery_option"]');
    const addressSection = document.getElementById('address-section');
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
    const instructionContent = document.getElementById('instruction-content');

    // Show address section if delivery is selected
    deliveryOptionRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.value === 'delivery') {
                addressSection.classList.remove('hidden');
            } else {
                addressSection.classList.add('hidden');
            }
        });
    });

    // Initialize based on default selection (pickup is checked by default)
    const pickupRadio = document.querySelector('input[value="pickup"]');
    if (pickupRadio.checked) {
        addressSection.classList.add('hidden');
    }

    // Payment instructions
    const paymentInstructions = {
        'credit_card': `
            <p class="mb-2"><strong>Credit Card Payment Instructions:</strong></p>
            <ol class="list-decimal pl-5 space-y-1">
                <li>Enter your credit card details securely</li>
                <li>Verify the amount matches your order total</li>
                <li>Complete the 3D Secure authentication if prompted</li>
                <li>You will receive a confirmation email</li>
            </ol>
        `,
        'bank_transfer': `
            <p class="mb-2"><strong>Bank Transfer Instructions:</strong></p>
            <ol class="list-decimal pl-5 space-y-1">
                <li>Transfer funds to our account: 1234567890</li>
                <li>Reference: Order #${Math.floor(Math.random() * 10000)}</li>
                <li>Upload proof of payment</li>
                <li>Processing takes 1-2 business days</li>
            </ol>
        `,
        'cash_on_delivery': `
            <p class="mb-2"><strong>Cash on Delivery Instructions:</strong></p>
            <ol class="list-decimal pl-5 space-y-1">
                <li>No payment required now</li>
                <li>Pay cash when goods are delivered</li>
                <li>Have exact change if possible</li>
                <li>Check items before paying</li>
            </ol>
        `
    };

    // Show instructions when payment method is selected
    paymentMethodRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.checked && paymentInstructions[this.value]) {
                instructionContent.innerHTML = paymentInstructions[this.value];
            }
        });
    });

    // Initialize with default instructions
    instructionContent.innerHTML = '<p>Select a payment method to see instructions.</p>';
});
</script>
{% endblock %}