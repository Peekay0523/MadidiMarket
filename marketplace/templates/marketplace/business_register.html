{% extends 'marketplace/base.html' %}
{% load static %}

{% block title %}Register Business - Madidi Market{% endblock %}

{% block content %}
<div class="container mx-auto px-4 max-w-4xl">
    <h1 class="text-3xl font-bold mb-8">Register Your Business</h1>

    <div class="card">
        <p class="mb-6 text-gray-600">Register your business to start selling products and services on Madidi Market. Once registered, your application will be reviewed by our team.</p>

        <form method="post" id="businessForm">
            {% csrf_token %}
            <div class="mb-4">
                <label for="{{ form.name.id_for_label }}" class="block text-gray-700 mb-2">Business Name *</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.name.errors }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <label for="{{ form.description.id_for_label }}" class="block text-gray-700 mb-2">Business Description *</label>
                {{ form.description }}
                {% if form.description.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.description.errors }}</p>
                {% endif %}
            </div>

            <div class="mb-4">
                <label for="{{ form.address.id_for_label }}" class="block text-gray-700 mb-2">Business Address *</label>
                {{ form.address }}
                {% if form.address.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.address.errors }}</p>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="{{ form.phone_number.id_for_label }}" class="block text-gray-700 mb-2">Phone Number *</label>
                    {{ form.phone_number }}
                    {% if form.phone_number.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.phone_number.errors }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.email.id_for_label }}" class="block text-gray-700 mb-2">Email *</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.email.errors }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Location Selection Section -->
            <div class="mb-6">
                <label class="block text-gray-700 mb-2 font-semibold">
                    <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                    Business Location on Map
                </label>
                <p class="text-sm text-gray-600 mb-3">
                    Click on the map below to set your business location. This will help customers find your business.
                </p>
                
                <!-- Hidden fields for coordinates -->
                {{ form.latitude }}
                {{ form.longitude }}
                
                <!-- Map container -->
                <div id="map" class="w-full h-96 rounded-lg border-2 border-gray-300 mb-3"></div>
                
                <!-- Coordinates display -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded-md">
                        <span class="text-gray-600">Latitude:</span>
                        <span id="latDisplay" class="font-mono ml-2">Not set</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <span class="text-gray-600">Longitude:</span>
                        <span id="lngDisplay" class="font-mono ml-2">Not set</span>
                    </div>
                </div>
                
                <div class="mt-2 flex gap-2">
                    <button type="button" id="useCurrentLocation" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-location-arrow mr-2"></i>Use Current Location
                    </button>
                    <button type="button" id="clearLocation" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">
                        <i class="fas fa-times mr-2"></i>Clear Location
                    </button>
                </div>
                
                {% if form.latitude.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.latitude.errors }}</p>
                {% endif %}
                {% if form.longitude.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.longitude.errors }}</p>
                {% endif %}
            </div>

            <button type="submit" class="btn-primary w-full py-3">Register Business</button>
        </form>
    </div>

    <div class="mt-8 text-center">
        <a href="{% url 'marketplace:home' %}" class="text-blue-600 hover:underline">&larr; Back to Home</a>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Default to Namibia (Windhoek)
        const defaultLat = -22.957689;
        const defaultLng = 18.490417;
        
        // Initialize map
        var map = L.map('map').setView([defaultLat, defaultLng], 13);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(map);
        
        // Create a marker (initially not placed)
        var marker = null;
        
        // Get the hidden input fields
        const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
        const lngInput = document.getElementById('{{ form.longitude.id_for_label }}');
        const latDisplay = document.getElementById('latDisplay');
        const lngDisplay = document.getElementById('lngDisplay');
        
        // Function to update marker and displays
        function updateLocation(lat, lng) {
            // Remove existing marker if any
            if (marker) {
                map.removeLayer(marker);
            }
            
            // Add new marker
            marker = L.marker([lat, lng]).addTo(map);
            
            // Update hidden inputs
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            
            // Update display
            latDisplay.textContent = lat.toFixed(6);
            lngDisplay.textContent = lng.toFixed(6);
            latDisplay.classList.add('text-green-600', 'font-semibold');
            lngDisplay.classList.add('text-green-600', 'font-semibold');
        }
        
        // Map click event to set location
        map.on('click', function(e) {
            updateLocation(e.latlng.lat, e.latlng.lng);
        });
        
        // Use current location button
        document.getElementById('useCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Getting location...';
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        updateLocation(position.coords.latitude, position.coords.longitude);
                        map.setView([position.coords.latitude, position.coords.longitude], 15);
                        document.getElementById('useCurrentLocation').innerHTML = '<i class="fas fa-check mr-2"></i>Location Set';
                    },
                    function(error) {
                        alert('Unable to get your location. Please click on the map instead.');
                        console.error('Geolocation error:', error);
                        document.getElementById('useCurrentLocation').innerHTML = '<i class="fas fa-location-arrow mr-2"></i>Use Current Location';
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser. Please click on the map instead.');
            }
        });
        
        // Clear location button
        document.getElementById('clearLocation').addEventListener('click', function() {
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            latInput.value = '';
            lngInput.value = '';
            latDisplay.textContent = 'Not set';
            lngDisplay.textContent = 'Not set';
            latDisplay.classList.remove('text-green-600', 'font-semibold');
            lngDisplay.classList.remove('text-green-600', 'font-semibold');
        });
        
        // Form validation - check if location is set
        document.getElementById('businessForm').addEventListener('submit', function(e) {
            if (!latInput.value || !lngInput.value) {
                if (!confirm('You haven\'t set a location on the map yet. Customers won\'t be able to find your business easily. Are you sure you want to continue without setting a location?')) {
                    e.preventDefault();
                }
            }
        });
    });
</script>

<style>
    #map {
        z-index: 1;
    }
</style>
{% endblock %}
